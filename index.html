<!DOCTYPE html>
<meta charset="utf-8">
<style>


</style>
<body>
<h1 style="text-align: center; font-family: 'Shadows Into Light', cursive; color: green">USA Flights 2008 Visualization made by Oleksii Renov</h1>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/main.css">
<link href='http://fonts.googleapis.com/css?family=Shadows+Into+Light' rel='stylesheet' type='text/css'>
<script type="text/javascript">

    var div = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);
    var w = 1200;
    var h = 600;
    var projection = d3.geo.albersUsa()
            .translate([w/2, h/2])
            .scale([1300]);
    var path = d3.geo.path()
            .projection(projection);
    var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("align", "center")
            .attr("height", h);
    d3.json("data/us-states.json", function(json) {  
        d3.csv("data/links2.csv", function(links){  
            d3.csv("data/city.csv", function(data) {
                svg.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("style", function(d){
                        return d.properties.name;
                    });
            
                data.forEach(function(d) { d.Freq = +d.Freq; });
                var maxFreq = d3.max(data, function(d) { return d.Freq; });
                var minFreq = d3.min(data, function(d) { return d.Freq; });
                var scaleRadius = d3.scale.log()
                        .domain([minFreq, maxFreq])
                        .range([0.1, 7]);
                svg.selectAll("circle")
                   .data(data)
                   .enter()
                   .append("circle")
                   .attr("cx", function(d) {
                           return projection([d.long, d.lat])[0];
                   })
                   .attr("cy", function(d) {
                           return projection([d.long, d.lat])[1];
                   })
                   .attr("r", function(d){return scaleRadius(d.Freq);})
                   .attr("city", function(d){return d.city;})
                   .attr("airport", function(d){return d.airport;})
                   .attr("freq", function(d){return d.Freq;})
                   .attr("stateabbrv", function(d){return d.state;})
                   .attr("id", function(d) {return d.Var1;})
                   .style("fill", "yellow")
                   .style("opacity", 0.75)
                   .on("mouseover", function(d) {      
                        div.transition()        
                            .duration(200)      
                            .style("opacity", .9);      
                        div.html("<b>State: </b>" + d.State + "<br/>" + "<b>City: </b> " + d.city + "<br/>"  +  "<b>Number of flight: </b>" + d.Freq + "<br/>" +
                          "<b>Airport: </b>" + d.airport )  
                            .style("left", (d3.event.pageX) + "px")     
                            .style("top", (d3.event.pageY - 28) + "px");    
                    })                  
                    .on("mouseout", function(d) {       
                        div.transition()        
                            .duration(500)      
                            .style("opacity", 0);   
                    });
                    
                var link = svg.selectAll(".link")
                    .data(links)
                    .enter().append("g")
                    .attr("class", "linkg");
                svg.selectAll(".linkg")
                    .data(links)
                    .append("path")
                    .attr("class", function(d) {

                        return "link " + "from" + d.from + " to" + d.to;
                      })
                    .attr("id" ,function(d) {
                        return "link" + "from" + d.from;
                      })      
                    .attr("d", function(d) {
                        try {
                                var from = d3.select("#"+d.from);
                                var to = d3.select("#"+d.to);
                                var sx = from.attr("cx"), sy = from.attr("cy"),
                                tx = to.attr("cx"), ty = to.attr("cy"),
                                dx = tx - sx, dy = ty - sy,
                                dr = 2 * Math.sqrt(dx * dx + dy * dy);
                                return "M" + sx + "," + sy + "A" + dr + "," + dr + " 0 0,1 " + tx + "," + ty;
                        }
                        catch(err)
                        {
                            return;
                        }
                      })
                    .style("stroke", "grey")
                    .style("stroke-width", function(d) { 
                        return  1; 
                    });
                svg.selectAll("circle")
                    .on("click", function(d) {

                        var xPosition = d3.select(this).attr("cx");
                        var yPosition = d3.select(this).attr("cy");
                        var q = "#linkfrom" + d.Var1;
                        console.log(q);
                        var unkn = d3.selectAll(q);
                        console.log(unkn);

                        d3.selectAll(q)
                            .transition()
                            .duration(10)
                            .style("stroke", "red")
                            .style("display", "block")
                            .style("stroke-opacity", ".7");
                        
                        d3.select(this).style("fill", "LightGoldenRodYellow");
                    });
            });

        });
    });
            
</script>
